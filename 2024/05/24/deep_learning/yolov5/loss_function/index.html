<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Yolov5代码解析(损失函数) | Grapymage的个人博客</title><meta name="author" content="Grapymage"><meta name="copyright" content="Grapymage"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="项目地址 [toc] ComputeLoss类 损失函数的计算主要集中在ComputeLoss类中, 下面对其内部的方法作逐一讲解 __init__函数 函数代码如下   sort_obj_iou表示是否对物体的iou进行排序, 在__call__函数中会用到, 这里设置的是False 1sort_obj_iou &#x3D; False  device存储模型参数的设备, CPU or GPU 1devi">
<meta property="og:type" content="article">
<meta property="og:title" content="Yolov5代码解析(损失函数)">
<meta property="og:url" content="https://zhangtingyu11.github.io/2024/05/24/deep_learning/yolov5/loss_function/index.html">
<meta property="og:site_name" content="Grapymage的个人博客">
<meta property="og:description" content="项目地址 [toc] ComputeLoss类 损失函数的计算主要集中在ComputeLoss类中, 下面对其内部的方法作逐一讲解 __init__函数 函数代码如下   sort_obj_iou表示是否对物体的iou进行排序, 在__call__函数中会用到, 这里设置的是False 1sort_obj_iou &#x3D; False  device存储模型参数的设备, CPU or GPU 1devi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zhangtingyu11.github.io/img/avatar.jpeg">
<meta property="article:published_time" content="2024-05-24T11:56:58.000Z">
<meta property="article:modified_time" content="2024-06-26T06:24:54.543Z">
<meta property="article:author" content="Grapymage">
<meta property="article:tag" content="yolov5">
<meta property="article:tag" content="代码解析">
<meta property="article:tag" content="损失函数">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhangtingyu11.github.io/img/avatar.jpeg"><link rel="shortcut icon" href="/img/avatar.jpeg"><link rel="canonical" href="https://zhangtingyu11.github.io/2024/05/24/deep_learning/yolov5/loss_function/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Yolov5代码解析(损失函数)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-26 14:24:54'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"><link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">119</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">66</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">56</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-file-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/top_img.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Grapymage的个人博客"><span class="site-name">Grapymage的个人博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-file-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Yolov5代码解析(损失函数)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-24T11:56:58.000Z" title="发表于 2024-05-24 19:56:58">2024-05-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-26T06:24:54.543Z" title="更新于 2024-06-26 14:24:54">2024-06-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/yolov5/">yolov5</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title="Yolov5代码解析(损失函数)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov5">项目地址</a><br>
[toc]</p>
<h1 id="computeloss类">ComputeLoss类</h1>
<p>损失函数的计算主要集中在<code>ComputeLoss</code>类中, 下面对其内部的方法作逐一讲解</p>
<h2 id="init-函数">__init__函数</h2>
<p>函数代码如下<br>
<img src="https://raw.githubusercontent.com/zhangtingyu11/PictureBed/main/202405241020670.png" alt=""><br>
<br>
<code>sort_obj_iou</code>表示是否对物体的iou进行排序, 在<a href="#__call__%E5%87%BD%E6%95%B0">__call__函数</a>中会用到, 这里设置的是False</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sort_obj_iou = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p><br>
<code>device</code>存储模型参数的设备, CPU or GPU</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">device = <span class="built_in">next</span>(model.parameters()).device</span><br></pre></td></tr></table></figure>
<p><br>
<code>h</code>是模型的超参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h = model.hyp  <span class="comment"># hyperparameters</span></span><br></pre></td></tr></table></figure>
<p><br>
构建网络分类loss和objectness loss, 可以参考<a href="#nnbcewithlogitsloss%E5%87%BD%E6%95%B0">nn.BCEWithLogitsLoss函数</a>, 他们的正样本权重都是1.0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BCEcls = nn.BCEWithLogitsLoss(pos_weight=torch.tensor([h[<span class="string">&quot;cls_pw&quot;</span>]], device=device))</span><br><span class="line">BCEobj = nn.BCEWithLogitsLoss(pos_weight=torch.tensor([h[<span class="string">&quot;obj_pw&quot;</span>]], device=device))</span><br></pre></td></tr></table></figure>
<p><br>
进行标签平滑, 参考<a href="#smooth_bce%E5%87%BD%E6%95%B0">smooth_bce函数</a>, yolov5中并没有进行标签平滑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.cp, self.cn = smooth_BCE(eps=h.get(<span class="string">&quot;label_smoothing&quot;</span>, <span class="number">0.0</span>))  <span class="comment"># positive, negative BCE targets</span></span><br></pre></td></tr></table></figure>
<p><br>
如果设置了<code>fl_gamma</code>, 就会使用<a href="#focalloss%E7%B1%BB">focalloss类</a>, 但是yolov5中没有使用focal loss</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">g = h[<span class="string">&quot;fl_gamma&quot;</span>]  <span class="comment"># focal loss gamma</span></span><br><span class="line"><span class="keyword">if</span> g &gt; <span class="number">0</span>:</span><br><span class="line">	BCEcls, BCEobj = FocalLoss(BCEcls, g), FocalLoss(BCEobj, g)</span><br></pre></td></tr></table></figure>
<p><br>
获取Detect模块, 如果是并行模型, 需要用<code>model.module</code>获取模块, 否则使用<code>model</code>获取模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">m = de_parallel(model).model[-<span class="number">1</span>]  <span class="comment"># Detect() module</span></span><br><span class="line"><span class="comment"># 用到的函数定义</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_parallel</span>(<span class="params">model</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Checks if the model is using Data Parallelism (DP) or Distributed Data Parallelism (DDP).&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">type</span>(model) <span class="keyword">in</span> (nn.parallel.DataParallel, nn.parallel.DistributedDataParallel)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">de_parallel</span>(<span class="params">model</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns a single-GPU model by removing Data Parallelism (DP) or Distributed Data Parallelism (DDP) if applied.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> model.module <span class="keyword">if</span> is_parallel(model) <span class="keyword">else</span> model</span><br></pre></td></tr></table></figure>
<p><br>
控制不同层的objectness loss的权重, 如果层数是三层就使用[4.0, 1.0, 0.4], 尺寸越小的层, 权重越低, 如果不是三层, 就是五层, 使用[4.0, 1.0, 0.25, 0.06, 0.02]这个权重</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.balance = &#123;<span class="number">3</span>: [<span class="number">4.0</span>, <span class="number">1.0</span>, <span class="number">0.4</span>]&#125;.get(m.nl, [<span class="number">4.0</span>, <span class="number">1.0</span>, <span class="number">0.25</span>, <span class="number">0.06</span>, <span class="number">0.02</span>])  <span class="comment"># P3-P7</span></span><br></pre></td></tr></table></figure>
<p><br>
后面可能会动态变换每一层的objectness损失的权重, 变换完之后将<code>self.ssi</code>这一层的权重设置成1, 其他层都成比例进行变化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.ssi = <span class="built_in">list</span>(m.stride).index(<span class="number">16</span>) <span class="keyword">if</span> autobalance <span class="keyword">else</span> <span class="number">0</span>  <span class="comment"># stride 16 index</span></span><br></pre></td></tr></table></figure>
<p><br>
设置损失函数及一些超参数, 其中<code>self.gr</code>是iou的比例, 在<a href="#__call__%E5%87%BD%E6%95%B0">__call__函数</a>中会提到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.BCEcls, self.BCEobj, self.gr, self.hyp, self.autobalance = BCEcls, BCEobj, <span class="number">1.0</span>, h, autobalance</span><br></pre></td></tr></table></figure>
<p><br>
<code>self.na</code>是anchor的数量, <code>self.nc</code>是类别的数量, <code>self.nl</code>是anchor层的数量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.na = m.na  <span class="comment"># number of anchors</span></span><br><span class="line">self.nc = m.nc  <span class="comment"># number of classes</span></span><br><span class="line">self.nl = m.nl  <span class="comment"># number of layers</span></span><br></pre></td></tr></table></figure>
<p><br>
设置锚框</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.anchors = m.anchors</span><br></pre></td></tr></table></figure>
<p><br>
设置设备</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.device = device</span><br></pre></td></tr></table></figure>
<h2 id="call-函数">__call__函数</h2>
<p>代码如下<br>
<img src="https://raw.githubusercontent.com/zhangtingyu11/PictureBed/main/202405241418501.png" alt=""></p>
<p><br>
分类的loss,  包围框的loss, objectness的loss</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lcls = torch.zeros(<span class="number">1</span>, device=self.device)  <span class="comment"># class loss</span></span><br><span class="line">lbox = torch.zeros(<span class="number">1</span>, device=self.device)  <span class="comment"># box loss</span></span><br><span class="line">lobj = torch.zeros(<span class="number">1</span>, device=self.device)  <span class="comment"># object loss</span></span><br></pre></td></tr></table></figure>
<p>根据预测和标签构建target, 其中<code>p</code>是预测值, <code>targets</code>是目标值, 具体可以参考<a href="#build_targets%E5%87%BD%E6%95%B0">build_targets函数</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcls, tbox, indices, anchors = self.build_targets(p, targets)  <span class="comment"># targets</span></span><br></pre></td></tr></table></figure>
<p><br>
遍历每一层的预测结果, <code>pi</code>是第<code>i</code>层的预测结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i, pi <span class="keyword">in</span> <span class="built_in">enumerate</span>(p):  <span class="comment"># layer index, layer predictions</span></span><br></pre></td></tr></table></figure>
<p><br>
获取第<code>i</code>层存储的索引, <code>b</code>是batch_idx, <code>a</code>是anchor索引, <code>gj</code>是网格的y坐标索引, <code>gi</code>是网格的x坐标索引<br>
每个变量的长都是参与预测的网格的数量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b, a, gj, gi = indices[i]</span><br></pre></td></tr></table></figure>
<p><br>
创建一个尺寸为(batch_size, 3, 特征图宽, 特征图高)全零张量, 用来存储每个网格的每个anchor的objectness目标</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tobj = torch.zeros(pi.shape[:<span class="number">4</span>], dtype=pi.dtype, device=self.device)  <span class="comment"># target obj</span></span><br></pre></td></tr></table></figure>
<p><br>
<code>n</code>是参与预测的网格的数量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">n = b.shape[<span class="number">0</span>]  <span class="comment"># number of targets</span></span><br></pre></td></tr></table></figure>
<p><br>
如果有网格负责预测</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> n:</span><br></pre></td></tr></table></figure>
<p><br>
获取负责预测的网格的预测信息, <code>pxy</code>是预测的包围框的偏差, <code>pwh</code>是预测的宽高, <code>pcls</code>是预测的类别</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pxy, pwh, _, pcls = pi[b, a, gj, gi].split((<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, self.nc), <span class="number">1</span>)  <span class="comment"># target-subset of predictions</span></span><br></pre></td></tr></table></figure>
<p><br>
将预测的坐标偏差求sigmoid, 然后减去0.5, 相当于不需要预测grid边缘到grid中心的距离</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pxy = pxy.sigmoid() * <span class="number">2</span> - <span class="number">0.5</span></span><br></pre></td></tr></table></figure>
<p><br>
<code>pwh</code>求sigmoid然后乘2再平方乘上anchor的尺寸作为预测的宽高</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwh = (pwh.sigmoid() * <span class="number">2</span>) ** <span class="number">2</span> * anchors[i]</span><br></pre></td></tr></table></figure>
<p><br>
将坐标的偏差和宽高进行拼接</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pbox = torch.cat((pxy, pwh), <span class="number">1</span>)  <span class="comment"># predicted box</span></span><br></pre></td></tr></table></figure>
<p><br>
使用CIoU计算, 参考<a href="#bbox_iou%E5%87%BD%E6%95%B0">bbox_iou函数</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iou = bbox_iou(pbox, tbox[i], CIoU=<span class="literal">True</span>).squeeze()  <span class="comment"># iou(prediction, target)</span></span><br></pre></td></tr></table></figure>
<p><br>
更新box损失</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lbox += (<span class="number">1.0</span> - iou).mean()  <span class="comment"># iou loss</span></span><br></pre></td></tr></table></figure>
<p><br>
获取iou, 如果需要对iou排序, 就进行排序, 然后更新所有相应的属性的顺序, 实际上yolov5并没有用到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iou = iou.detach().clamp(<span class="number">0</span>).<span class="built_in">type</span>(tobj.dtype)</span><br><span class="line"><span class="keyword">if</span> self.sort_obj_iou:</span><br><span class="line">	j = iou.argsort()</span><br><span class="line">	b, a, gj, gi, iou = b[j], a[j], gj[j], gi[j], iou[j]</span><br></pre></td></tr></table></figure>
<p><br>
变化iou, 如果<code>self.gr</code>是1, iou不变, 否则iou会变小, 人为增加训练难度</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.gr &lt; <span class="number">1</span>:</span><br><span class="line">	iou = (<span class="number">1.0</span> - self.gr) + self.gr * iou</span><br></pre></td></tr></table></figure>
<p><br>
将objectness设置成IoU的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tobj[b, a, gj, gi] = iou  <span class="comment"># iou ratio</span></span><br></pre></td></tr></table></figure>
<p><br>
使用平滑后的标签来替换原来的标签, 然后计算分类的损失</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.nc &gt; <span class="number">1</span>:  <span class="comment"># cls loss (only if multiple classes)</span></span><br><span class="line">	t = torch.full_like(pcls, self.cn, device=self.device)  <span class="comment"># targets</span></span><br><span class="line">	t[<span class="built_in">range</span>(n), tcls[i]] = self.cp</span><br><span class="line">	lcls += self.BCEcls(pcls, t)  <span class="comment"># BCE</span></span><br></pre></td></tr></table></figure>
<p><br>
计算objectness的loss, objectness的loss需要乘上当前层的权重, 特征图越大, 权重越大</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obji = self.BCEobj(pi[..., <span class="number">4</span>], tobj)</span><br><span class="line">lobj += obji * self.balance[i]  <span class="comment"># obj loss</span></span><br></pre></td></tr></table></figure>
<p><br>
根绝计算出来的损失来更新这一层objectness的权重, 如果损失越大, 权重就越大, 但是yolov5没用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.autobalance:</span><br><span class="line">	self.balance[i] = self.balance[i] * <span class="number">0.9999</span> + <span class="number">0.0001</span> / obji.detach().item()</span><br></pre></td></tr></table></figure>
<p><br>
将第<code>self.ssi</code>层作为基准, 这一层的objectness的损失权重为1, 其他成比例变化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.autobalance:</span><br><span class="line">	self.balance = [x / self.balance[self.ssi] <span class="keyword">for</span> x <span class="keyword">in</span> self.balance]</span><br></pre></td></tr></table></figure>
<p><br>
将每个损失乘上超参数的权重, 然后返回损失, 最后的损失乘上了batch_size</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lbox *= self.hyp[<span class="string">&quot;box&quot;</span>]</span><br><span class="line">lobj *= self.hyp[<span class="string">&quot;obj&quot;</span>]</span><br><span class="line">lcls *= self.hyp[<span class="string">&quot;cls&quot;</span>]</span><br><span class="line">bs = tobj.shape[<span class="number">0</span>]  <span class="comment"># batch size</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (lbox + lobj + lcls) * bs, torch.cat((lbox, lobj, lcls)).detach()</span><br></pre></td></tr></table></figure>
<h2 id="build-targets函数">build_targets函数</h2>
<p>代码如下<br>
<img src="https://raw.githubusercontent.com/zhangtingyu11/PictureBed/main/202405241424779.png" alt=""></p>
<p><code>na</code>表示anchor的数量, <code>nt</code>表示gt包围框的数量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">na, nt = self.na, targets.shape[<span class="number">0</span>]  <span class="comment"># number of anchors, targets</span></span><br></pre></td></tr></table></figure>
<p><br>
初始化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcls, tbox, indices, anch = [], [], [], []</span><br></pre></td></tr></table></figure>
<p><br>
<code>gain</code>存放了每个维度所需要乘上的倍率, 后面会将坐标和高宽从0~1变为实际值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gain = torch.ones(<span class="number">7</span>, device=self.device)  <span class="comment"># normalized to gridspace gain</span></span><br></pre></td></tr></table></figure>
<p><br>
<code>ai</code>的尺寸是(3, gt框)的, 第一行全是0, 第二行全是1, 第三行全是2</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ai = torch.arange(na, device=self.device).<span class="built_in">float</span>().view(na, <span class="number">1</span>).repeat(<span class="number">1</span>, nt)  <span class="comment"># same as .repeat_interleave(nt)</span></span><br></pre></td></tr></table></figure>
<p><br>
<code>targets</code>的尺寸一开始是(gt框个数, 6), 后面变成了(3, gt框个数, 7), 其中<code>repeat</code>函数是后对齐的, 会先向最前面补充维度, 也就是先将<code>targets</code>的维度变成(1, gt框个数, 6)然后在repeat</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">targets = torch.cat((targets.repeat(na, <span class="number">1</span>, <span class="number">1</span>), ai[..., <span class="literal">None</span>]), <span class="number">2</span>)  <span class="comment"># append anchor indices</span></span><br></pre></td></tr></table></figure>
<p><br>
设置offset, 为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tensor([[ <span class="number">0.00000</span>,  <span class="number">0.00000</span>],</span><br><span class="line">        [ <span class="number">0.50000</span>,  <span class="number">0.00000</span>],</span><br><span class="line">        [ <span class="number">0.00000</span>,  <span class="number">0.50000</span>],</span><br><span class="line">        [-<span class="number">0.50000</span>,  <span class="number">0.00000</span>],</span><br><span class="line">        [ <span class="number">0.00000</span>, -<span class="number">0.50000</span>]], device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">g = <span class="number">0.5</span>  <span class="comment"># bias</span></span><br><span class="line">off = (</span><br><span class="line">	torch.tensor(</span><br><span class="line">		[</span><br><span class="line">			[<span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">			[<span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">			[<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">			[-<span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">			[<span class="number">0</span>, -<span class="number">1</span>],  <span class="comment"># j,k,l,m</span></span><br><span class="line">			<span class="comment"># [1, 1], [1, -1], [-1, 1], [-1, -1],  # jk,jm,lk,lm</span></span><br><span class="line">		],</span><br><span class="line">		device=self.device,</span><br><span class="line">	).<span class="built_in">float</span>()</span><br><span class="line">	* g</span><br><span class="line">)  <span class="comment"># offsets</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><br>
遍历每一个anchor层</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.nl):</span><br></pre></td></tr></table></figure>
<p><br>
获取这一层的anchor配置以及这一层的预测的形状</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">anchors, shape = self.anchors[i], p[i].shape</span><br></pre></td></tr></table></figure>
<p><br>
<code>targets</code>的尺寸为(3, gt框大小, 7), 其中7维分别表示batch_idx, 类别, 中心点x坐标, 中心点y坐标, w, h, 对应的anchor的索引<br>
需要注意的是<mark style="background: #ff6666">坐标和高宽都是根据长宽归一化到了0~1之间</mark>, 因此在代码里将gain[2:6]的值设置成了特征图的长宽,后面乘上了归一化后的坐标</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gain[<span class="number">2</span>:<span class="number">6</span>] = torch.tensor(shape)[[<span class="number">3</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>]]  <span class="comment"># xyxy gain</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Match targets to anchors</span></span><br><span class="line">t = targets * gain  <span class="comment"># shape(3,n,7)</span></span><br></pre></td></tr></table></figure>
<p><br>
如果这些图片里面有gt框</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> nt:</span><br></pre></td></tr></table></figure>
<p><br>
获取真实的宽高对于anchor的宽高的比例, 取最大的比例, 需要这个比例小于<code>self.hyp[&quot;anchor_t&quot;]</code>, yolov5中设置的是4, 然后将这些gt框保留下来, 目的应该是如果有些gt框和anchor差距太大就放弃</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r = t[..., <span class="number">4</span>:<span class="number">6</span>] / anchors[:, <span class="literal">None</span>]  <span class="comment"># wh ratio</span></span><br><span class="line">j = torch.<span class="built_in">max</span>(r, <span class="number">1</span> / r).<span class="built_in">max</span>(<span class="number">2</span>)[<span class="number">0</span>] &lt; self.hyp[<span class="string">&quot;anchor_t&quot;</span>]  <span class="comment"># compare</span></span><br><span class="line">t = t[j]  <span class="comment"># filter</span></span><br></pre></td></tr></table></figure>
<p><br>
中心点坐标的位置(距离左边和上边)以及其逆坐标(距离右边和下边)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gxy = t[:, <span class="number">2</span>:<span class="number">4</span>]  <span class="comment"># grid xy</span></span><br><span class="line">gxi = gain[[<span class="number">2</span>, <span class="number">3</span>]] - gxy  <span class="comment"># inverse</span></span><br></pre></td></tr></table></figure>
<p>具体的如下图所示<br>
<img src="https://raw.githubusercontent.com/zhangtingyu11/PictureBed/main/202405241530905.png" alt=""></p>
<p><br>
判断中心点在网格的什么位置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">j, k = ((gxy % <span class="number">1</span> &lt; g) &amp; (gxy &gt; <span class="number">1</span>)).T</span><br><span class="line">l, m = ((gxi % <span class="number">1</span> &lt; g) &amp; (gxi &gt; <span class="number">1</span>)).T</span><br></pre></td></tr></table></figure>
<p>下面图片表示了各个标志的含义, 如果在某一半侧, 就需要这个点所在这一网格不能在这一侧的边缘上, 例如如果在左半侧, 那么其所在的网格不能在左边边缘上. 这也是为什么要选择4个标志位的原因(不然<code>j</code>和<code>l</code>可以相互替代)<br>
<img src="https://raw.githubusercontent.com/zhangtingyu11/PictureBed/main/202405241536067.png" alt=""></p>
<p>将<code>j, k, l, m</code>进行拼接, 还增加了一个全1的也拼接. 其中<code>torch.ones_like(j)</code>表示一定会用到当前的grid进行预测, <code>j</code>表示如果落在grid的左侧, 其左边的网格也参与预测, <code>k</code>表示如果落在grid的上侧, 其上面的网格也参与预测, <code>l</code>表示如果落在grid的右侧, 其右边的网格也参与预测, <code>m</code>表示如果落在grid的下侧, 其下面的网格也参与预测</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">j = torch.stack((torch.ones_like(j), j, k, l, m))</span><br></pre></td></tr></table></figure>
<p><br>
将目标复制5份, 然后将需要参与预测的grid对应的gt选出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t = t.repeat((<span class="number">5</span>, <span class="number">1</span>, <span class="number">1</span>))[j]</span><br></pre></td></tr></table></figure>
<p><br>
计算不同的grid cell对应的offset</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">offsets = (torch.zeros_like(gxy)[<span class="literal">None</span>] + off[:, <span class="literal">None</span>])[j]</span><br></pre></td></tr></table></figure>
<p><br>
如果没有gt框, 上面提到的操作就跳过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	t = targets[<span class="number">0</span>]</span><br><span class="line">	offsets = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p><br>
将target分成四份, chunk方法, 如果维度的数量能整除分成的块数, 那么每一块的数量都是一样的, 否则除了最后一个之外, 数量都是一样的. <mark style="background: #ff6666">注意: 分成的块数可能少于设置的块数</mark><br>
其中<code>bc</code>是(所在的batch_idx, 类别), <code>gxy</code>中心点xy坐标, <code>gwh</code>是gt的宽高, <code>a</code>是对应的anchor索引</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bc, gxy, gwh, a = t.chunk(<span class="number">4</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><br>
将索引类型的都转化成long</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a, (b, c) = a.long().view(-<span class="number">1</span>), bc.long().T  <span class="comment"># anchors, image, class</span></span><br></pre></td></tr></table></figure>
<p><br>
用点的位置减去offset求网格中的点的索引</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gij = (gxy - offsets).long()</span><br><span class="line">gi, gj = gij.T  <span class="comment"># grid indices</span></span><br></pre></td></tr></table></figure>
<p><br>
将batch_idx, anchor的索引, 网格的索引加入<code>indices</code>里面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">indices.append((b, a, gj.clamp_(<span class="number">0</span>, shape[<span class="number">2</span>] - <span class="number">1</span>), gi.clamp_(<span class="number">0</span>, shape[<span class="number">3</span>] - <span class="number">1</span>)))  <span class="comment"># image, anchor, grid</span></span><br></pre></td></tr></table></figure>
<p><br>
<code>tbox</code>里面存的是, 坐标相对于当前网格中心点的偏差, 包围框的宽高</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tbox.append(torch.cat((gxy - gij, gwh), <span class="number">1</span>))  <span class="comment"># box</span></span><br></pre></td></tr></table></figure>
<p><br>
添加anchor</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">anch.append(anchors[a])  <span class="comment"># anchors</span></span><br></pre></td></tr></table></figure>
<p>\添加类别</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcls.append(c)  <span class="comment"># class</span></span><br></pre></td></tr></table></figure>
<p>返回值的含义如下</p>
<ul>
<li><code>tcls</code>: 长度为3的列表, 列表中的每一个元素存放的都是负责检测的grid所应该检测的包围框的类别</li>
<li><code>tbox</code>: 长度为3的列表, 列表中的每一个元素存放的都是负责检测的grid所应该检测的包围框的包围框信息, 包括包围框中心点到grid中心点的偏差, 包围框宽高</li>
<li><code>indices</code>: 长度为3的列表, 列表中的每一个元素存放的都是负责检测的grid所应该检测的包围框的索引信息, 包括所检测的包围框的batch_idx, anchor索引, 网格索引</li>
<li><code>anchor</code>: 长度为3的列表, 列表中的每一个元素存放的都是负责检测的grid所应该检测的包围框的anchor信息, 包括anchor的大小</li>
</ul>
<h1 id="其他用到的函数">其他用到的函数</h1>
<h2 id="nn-bcewithlogitsloss函数">nn.BCEWithLogitsLoss函数</h2>
<p>这是<a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.BCEWithLogitsLoss.html">pytorch的内置函数</a>, 损失的定义如下</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">ℓ</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>L</mi><mi>c</mi></msub><mo>=</mo><mo stretchy="false">{</mo><msub><mi>l</mi><mrow><mn>1</mn><mo separator="true">,</mo><mi>c</mi></mrow></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>l</mi><mrow><mi>N</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub><msup><mo stretchy="false">}</mo><mi mathvariant="normal">⊤</mi></msup><mspace linebreak="newline"></mspace><msub><mi>l</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub><mo>=</mo><mo>−</mo><msub><mi>w</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub><mrow><mo fence="true">[</mo><msub><mi>p</mi><mi>c</mi></msub><msub><mi>y</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub><mo>⋅</mo><mi>log</mi><mo>⁡</mo><mi>σ</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mi>y</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub><mo stretchy="false">)</mo><mo>⋅</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>σ</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\ell_c(x,y)=L_c=\{l_{1,c},\ldots,l_{N,c}\}^\top \\
l_{n,c}=-w_{n,c}\left[p_cy_{n,c}\cdot\log\sigma(x_{n,c})+(1-y_{n,c})\cdot\log(1-\sigma(x_{n,c}))\right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">ℓ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1852159999999998em;vertical-align:-0.286108em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span></span></span></p>
<p>其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>l</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub></mrow><annotation encoding="application/x-tex">l_{n, c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>表示第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>个样本在第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">c</span></span></span></span>个类别上的损失, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub></mrow><annotation encoding="application/x-tex">w_{n,c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>表示第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>个样本在第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">c</span></span></span></span>个类别上的权重, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{n,c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>表示第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>个样本在第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">c</span></span></span></span>个类别上的<strong>正样本权重</strong>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span></span></span></span>表示sigmoid函数, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub></mrow><annotation encoding="application/x-tex">x_{n,c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>表示第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>个样本在第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">c</span></span></span></span>个类别上的预测值<br>
官方文档中给出的正样本权重的解释是, 正样本权重如果&gt;1会增大召回率, 正样本权重如果&lt;1会增大精度<br>
如果样本中有100个正样本和300个负样本, 那么应该将正样本权重设置为3</p>
<h2 id="smooth-bce函数">smooth_BCE函数</h2>
<p>函数定义如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">smooth_BCE</span>(<span class="params">eps=<span class="number">0.1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns label smoothing BCE targets for reducing overfitting; pos: `1.0 - 0.5*eps`, neg: `0.5*eps`. For details see https://github.com/ultralytics/yolov3/issues/238#issuecomment-598028441&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1.0</span> - <span class="number">0.5</span> * eps, <span class="number">0.5</span> * eps</span><br></pre></td></tr></table></figure>
<h2 id="focalloss类">FocalLoss类</h2>
<p>定义如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FocalLoss</span>(nn.Module):</span><br><span class="line">    <span class="comment"># Wraps focal loss around existing loss_fcn(), i.e. criteria = FocalLoss(nn.BCEWithLogitsLoss(), gamma=1.5)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, loss_fcn, gamma=<span class="number">1.5</span>, alpha=<span class="number">0.25</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Initializes FocalLoss with specified loss function, gamma, and alpha values; modifies loss reduction to</span></span><br><span class="line"><span class="string">        &#x27;none&#x27;.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.loss_fcn = loss_fcn  <span class="comment"># must be nn.BCEWithLogitsLoss()</span></span><br><span class="line">        self.gamma = gamma</span><br><span class="line">        self.alpha = alpha</span><br><span class="line">        self.reduction = loss_fcn.reduction</span><br><span class="line">        self.loss_fcn.reduction = <span class="string">&quot;none&quot;</span>  <span class="comment"># required to apply FL to each element</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, pred, true</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Calculates the focal loss between predicted and true labels using a modified BCEWithLogitsLoss.&quot;&quot;&quot;</span></span><br><span class="line">        loss = self.loss_fcn(pred, true)</span><br><span class="line">        <span class="comment"># p_t = torch.exp(-loss)</span></span><br><span class="line">        <span class="comment"># loss *= self.alpha * (1.000001 - p_t) ** self.gamma  # non-zero power for gradient stability</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># TF implementation https://github.com/tensorflow/addons/blob/v0.7.1/tensorflow_addons/losses/focal_loss.py</span></span><br><span class="line">        pred_prob = torch.sigmoid(pred)  <span class="comment"># prob from logits</span></span><br><span class="line">        p_t = true * pred_prob + (<span class="number">1</span> - true) * (<span class="number">1</span> - pred_prob)</span><br><span class="line">        alpha_factor = true * self.alpha + (<span class="number">1</span> - true) * (<span class="number">1</span> - self.alpha)</span><br><span class="line">        modulating_factor = (<span class="number">1.0</span> - p_t) ** self.gamma</span><br><span class="line">        loss *= alpha_factor * modulating_factor</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.reduction == <span class="string">&quot;mean&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> loss.mean()</span><br><span class="line">        <span class="keyword">elif</span> self.reduction == <span class="string">&quot;sum&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> loss.<span class="built_in">sum</span>()</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># &#x27;none&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> loss</span><br></pre></td></tr></table></figure>
<p>没什么好说的, 就是正常FocalLoss的实现, 参考下面的公式</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mi>L</mi><mo stretchy="false">(</mo><mi>p</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mi>α</mi><mi>y</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><msup><mo stretchy="false">)</mo><mi>γ</mi></msup><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mo>−</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>α</mi><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>y</mi><mo stretchy="false">)</mo><msup><mi>p</mi><mi>γ</mi></msup><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">FL(p,y)=-\alpha y(1-p)^\gamma log(p)-(1-\alpha)(1-y)p^\gamma log(1-p)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault">L</span><span class="mopen">(</span><span class="mord mathdefault">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714392em;"><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05556em;">γ</span></span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathdefault">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714392em;"><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05556em;">γ</span></span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mclose">)</span></span></span></span></span></p>
<h2 id="bbox-iou函数">bbox_iou函数</h2>
<p>代码如下<br>
<img src="https://raw.githubusercontent.com/zhangtingyu11/PictureBed/main/202405241929459.png" alt=""><br>
如果包围框的存储方式是中心点坐标+宽高的形式, 就转化成左上角坐标和右下角坐标的形式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> xywh:  <span class="comment"># transform from xywh to xyxy</span></span><br><span class="line">	(x1, y1, w1, h1), (x2, y2, w2, h2) = box1.chunk(<span class="number">4</span>, -<span class="number">1</span>), box2.chunk(<span class="number">4</span>, -<span class="number">1</span>)</span><br><span class="line">	w1_, h1_, w2_, h2_ = w1 / <span class="number">2</span>, h1 / <span class="number">2</span>, w2 / <span class="number">2</span>, h2 / <span class="number">2</span></span><br><span class="line">	b1_x1, b1_x2, b1_y1, b1_y2 = x1 - w1_, x1 + w1_, y1 - h1_, y1 + h1_</span><br><span class="line">	b2_x1, b2_x2, b2_y1, b2_y2 = x2 - w2_, x2 + w2_, y2 - h2_, y2 + h2_</span><br><span class="line"><span class="keyword">else</span>:  <span class="comment"># x1, y1, x2, y2 = box1</span></span><br><span class="line">	b1_x1, b1_y1, b1_x2, b1_y2 = box1.chunk(<span class="number">4</span>, -<span class="number">1</span>)</span><br><span class="line">	b2_x1, b2_y1, b2_x2, b2_y2 = box2.chunk(<span class="number">4</span>, -<span class="number">1</span>)</span><br><span class="line">	w1, h1 = b1_x2 - b1_x1, (b1_y2 - b1_y1).clamp(eps)</span><br><span class="line">	w2, h2 = b2_x2 - b2_x1, (b2_y2 - b2_y1).clamp(eps)</span><br></pre></td></tr></table></figure>
<p><br>
计算交集面积</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inter = (b1_x2.minimum(b2_x2) - b1_x1.maximum(b2_x1)).clamp(<span class="number">0</span>) * (</span><br><span class="line">	b1_y2.minimum(b2_y2) - b1_y1.maximum(b2_y1)</span><br><span class="line">).clamp(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p><br>
计算并集面积</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">union = w1 * h1 + w2 * h2 - inter + eps</span><br></pre></td></tr></table></figure>
<p><br>
计算基础iou</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iou = inter / union</span><br></pre></td></tr></table></figure>
<p><br>
根据不同的iou类型计算</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> CIoU <span class="keyword">or</span> DIoU <span class="keyword">or</span> GIoU:</span><br><span class="line">	cw = b1_x2.maximum(b2_x2) - b1_x1.minimum(b2_x1)  <span class="comment"># convex (smallest enclosing box) width</span></span><br><span class="line">	ch = b1_y2.maximum(b2_y2) - b1_y1.minimum(b2_y1)  <span class="comment"># convex height</span></span><br><span class="line">	<span class="keyword">if</span> CIoU <span class="keyword">or</span> DIoU:  <span class="comment"># Distance or Complete IoU https://arxiv.org/abs/1911.08287v1</span></span><br><span class="line">		c2 = cw**<span class="number">2</span> + ch**<span class="number">2</span> + eps  <span class="comment"># convex diagonal squared</span></span><br><span class="line">		rho2 = ((b2_x1 + b2_x2 - b1_x1 - b1_x2) ** <span class="number">2</span> + (b2_y1 + b2_y2 - b1_y1 - b1_y2) ** <span class="number">2</span>) / <span class="number">4</span>  <span class="comment"># center dist ** 2</span></span><br><span class="line">		<span class="keyword">if</span> CIoU:  <span class="comment"># https://github.com/Zzh-tju/DIoU-SSD-pytorch/blob/master/utils/box/box_utils.py#L47</span></span><br><span class="line">			v = (<span class="number">4</span> / math.pi**<span class="number">2</span>) * (torch.atan(w2 / h2) - torch.atan(w1 / h1)).<span class="built_in">pow</span>(<span class="number">2</span>)</span><br><span class="line">			<span class="keyword">with</span> torch.no_grad():</span><br><span class="line">				alpha = v / (v - iou + (<span class="number">1</span> + eps))</span><br><span class="line">			<span class="keyword">return</span> iou - (rho2 / c2 + v * alpha)  <span class="comment"># CIoU</span></span><br><span class="line">		<span class="keyword">return</span> iou - rho2 / c2  <span class="comment"># DIoU</span></span><br><span class="line">	c_area = cw * ch + eps  <span class="comment"># convex area</span></span><br><span class="line">	<span class="keyword">return</span> iou - (c_area - union) / c_area  <span class="comment"># GIoU https://arxiv.org/pdf/1902.09630.pdf</span></span><br><span class="line"><span class="keyword">return</span> iou  <span class="comment"># IoU</span></span><br></pre></td></tr></table></figure>
<p>yolov5使用的是CIoU, 下面介绍一下CIoU<br>
CIoU将传统的IoU替换成了</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mi>o</mi><mi>U</mi><mo>−</mo><mfrac><mrow><msup><mi>ρ</mi><mn>2</mn></msup><mo stretchy="false">(</mo><mi mathvariant="bold">b</mi><mo separator="true">,</mo><msup><mi mathvariant="bold">b</mi><mrow><mi>g</mi><mi>t</mi></mrow></msup><mo stretchy="false">)</mo></mrow><msup><mi>c</mi><mn>2</mn></msup></mfrac><mo>−</mo><mi>α</mi><mi>v</mi></mrow><annotation encoding="application/x-tex">IoU-\frac{\rho^2(\mathbf{b},\mathbf{b}^{gt})}{c^2}-\alpha v
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.177108em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">ρ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">b</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">b</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span></span></span></p>
<p>其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span></span>的定义如下</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>=</mo><mfrac><mn>4</mn><msup><mi>π</mi><mn>2</mn></msup></mfrac><mo stretchy="false">(</mo><mi>a</mi><mi>r</mi><mi>c</mi><mi>t</mi><mi>a</mi><mi>n</mi><mfrac><msup><mi>w</mi><mrow><mi>g</mi><mi>t</mi></mrow></msup><msup><mi>h</mi><mrow><mi>g</mi><mi>t</mi></mrow></msup></mfrac><mo>−</mo><mi>a</mi><mi>r</mi><mi>c</mi><mi>t</mi><mi>a</mi><mi>n</mi><mfrac><mi>w</mi><mi>h</mi></mfrac><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">v=\frac{4}{\pi^2}(arctan\frac{w^{gt}}{h^{gt}}-arctan\frac{w}{h})^2
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.156556em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.470556em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.719556em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.7935600000000003em;vertical-align:-0.686em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">h</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding="application/x-tex">\rho</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">ρ</span></span></span></span>表示两个包围框中心点的欧氏距离<br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span></span></span></span>的定义如下</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mfrac><mi>v</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>I</mi><mi>o</mi><mi>U</mi><mo stretchy="false">)</mo><mo>+</mo><mi>v</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\alpha=\frac v{(1-IoU)+v}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.0435600000000003em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">c</span></span></span></span>是最小包围框两个bbox的对角线长度</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zhangtingyu11.github.io">Grapymage</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zhangtingyu11.github.io/2024/05/24/deep_learning/yolov5/loss_function/">https://zhangtingyu11.github.io/2024/05/24/deep_learning/yolov5/loss_function/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhangtingyu11.github.io" target="_blank">Grapymage的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/yolov5/">yolov5</a><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/">代码解析</a><a class="post-meta__tags" href="/tags/%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0/">损失函数</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/03/paper_reading/contrastive_learning/clip/" title="CLIP:Learning Transferable Visual Models From Natural Language Supervision"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">CLIP:Learning Transferable Visual Models From Natural Language Supervision</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/22/algorithms/tricks/bootstrap_recursion/" title="使用bootstrap装饰器实现递归函数"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">使用bootstrap装饰器实现递归函数</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/05/21/deep_learning/yolov5/affine_perspective/" title="Yolov5代码解析(仿射变换和透视变换)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-21</div><div class="title">Yolov5代码解析(仿射变换和透视变换)</div></div></a></div><div><a href="/2024/05/21/deep_learning/yolov5/mixup/" title="Yolov5代码解析(mixup)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-21</div><div class="title">Yolov5代码解析(mixup)</div></div></a></div><div><a href="/2024/05/21/deep_learning/yolov5/model/" title="Yolov5代码解析(网络架构)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-21</div><div class="title">Yolov5代码解析(网络架构)</div></div></a></div><div><a href="/2024/05/20/deep_learning/yolov5/mosaic/" title="Yolov5代码解析(mosaic数据增强)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-20</div><div class="title">Yolov5代码解析(mosaic数据增强)</div></div></a></div><div><a href="/2024/06/06/deep_learning/interview/loss_function/alpha_iou_loss/" title="深度学习常用损失函数(Alpha IoU Loss)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-06</div><div class="title">深度学习常用损失函数(Alpha IoU Loss)</div></div></a></div><div><a href="/2024/06/05/deep_learning/interview/loss_function/bce_loss/" title="深度学习常用损失函数(BCE)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-05</div><div class="title">深度学习常用损失函数(BCE)</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Grapymage</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">119</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">66</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">56</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zhangtingyu11"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">无</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#computeloss%E7%B1%BB"><span class="toc-number">1.</span> <span class="toc-text">ComputeLoss类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#init-%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.</span> <span class="toc-text">__init__函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#call-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.</span> <span class="toc-text">__call__函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#build-targets%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.</span> <span class="toc-text">build_targets函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%94%A8%E5%88%B0%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">2.</span> <span class="toc-text">其他用到的函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nn-bcewithlogitsloss%E5%87%BD%E6%95%B0"><span class="toc-number">2.1.</span> <span class="toc-text">nn.BCEWithLogitsLoss函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#smooth-bce%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text">smooth_BCE函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#focalloss%E7%B1%BB"><span class="toc-number">2.3.</span> <span class="toc-text">FocalLoss类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bbox-iou%E5%87%BD%E6%95%B0"><span class="toc-number">2.4.</span> <span class="toc-text">bbox_iou函数</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/26/deep_learning/stanford_ml/chapter11/" title="斯坦福2021秋季·实用机器学习(第十一章)">斯坦福2021秋季·实用机器学习(第十一章)</a><time datetime="2024-06-26T07:04:34.000Z" title="发表于 2024-06-26 15:04:34">2024-06-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/26/deep_learning/stanford_ml/chapter10/" title="斯坦福2021秋季·实用机器学习(第十章)">斯坦福2021秋季·实用机器学习(第十章)</a><time datetime="2024-06-26T07:04:11.000Z" title="发表于 2024-06-26 15:04:11">2024-06-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/26/deep_learning/stanford_ml/chapter9/" title="斯坦福2021秋季·实用机器学习(第九章)">斯坦福2021秋季·实用机器学习(第九章)</a><time datetime="2024-06-26T07:03:24.000Z" title="发表于 2024-06-26 15:03:24">2024-06-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/26/deep_learning/stanford_ml/chapter5/" title="斯坦福2021秋季·实用机器学习(第五章)">斯坦福2021秋季·实用机器学习(第五章)</a><time datetime="2024-06-26T07:02:34.000Z" title="发表于 2024-06-26 15:02:34">2024-06-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/26/deep_learning/stanford_ml/chapter4/" title="斯坦福2021秋季·实用机器学习(第四章)">斯坦福2021秋季·实用机器学习(第四章)</a><time datetime="2024-06-26T06:56:43.000Z" title="发表于 2024-06-26 14:56:43">2024-06-26</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/top_img.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Grapymage</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://vercel-six-xi-75.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(init)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://vercel-six-xi-75.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
      
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>